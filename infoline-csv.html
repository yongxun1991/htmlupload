<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infoline CSV Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f7f9;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #007bff;
        }
        form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }
        input[type="text"], input[type="number"], input[type="url"], input[type="file"], select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .date-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .date-group select {
            flex: 1 1 80px;
            min-width: 80px;
        }
        .checkbox-group {
            display: flex;
            flex-direction: column;
            margin-top: 5px;
        }
        .checkbox-group label {
            font-weight: normal;
            margin-top: 5px;
        }
        button {
            display: inline-block;
            margin-top: 20px;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        #preview {
            margin-top: 20px;
            background: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <button type="button" onclick="location.reload()">Clean Record</button>
    <h1>Infoline CSV Converter</h1>
    <form id="converterForm">
        <label for="advertiser">Advertiser:</label>
        <input type="text" id="advertiser" required>

        <label for="campaignName">Campaign Name:</label>
        <input type="text" id="campaignName" required maxlength="50">

        <label for="region">Region (e.g., MENA for backend name):</label>
        <input type="text" id="region" required>

        <label>Campaign Start Date & Time:</label>
        <div class="date-group">
            <select id="startYear">
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
            <select id="startMonth">
                <option value="1">01 - January</option>
                <option value="2">02 - February</option>
                <option value="3">03 - March</option>
                <option value="4">04 - April</option>
                <option value="5">05 - May</option>
                <option value="6">06 - June</option>
                <option value="7">07 - July</option>
                <option value="8">08 - August</option>
                <option value="9">09 - September</option>
                <option value="10">10 - October</option>
                <option value="11">11 - November</option>
                <option value="12">12 - December</option>
            </select>
            <select id="startDay"></select>
            <select id="startHour"></select>
            <select id="startMin"></select>
            <select id="startSec"></select>
            <select id="startTimezone">
                <option value="-12">UTC-12</option>
                <option value="-11">UTC-11</option>
                <option value="-10">UTC-10</option>
                <option value="-9">UTC-9</option>
                <option value="-8">UTC-8</option>
                <option value="-7">UTC-7</option>
                <option value="-6">UTC-6</option>
                <option value="-5">UTC-5</option>
                <option value="-4">UTC-4</option>
                <option value="-3">UTC-3</option>
                <option value="-2">UTC-2</option>
                <option value="-1">UTC-1</option>
                <option value="0">UTC+0</option>
                <option value="1">UTC+1</option>
                <option value="2">UTC+2</option>
                <option value="3">UTC+3</option>
                <option value="4">UTC+4</option>
                <option value="5">UTC+5</option>
                <option value="6">UTC+6</option>
                <option value="7">UTC+7</option>
                <option value="8">UTC+8</option>
                <option value="9">UTC+9</option>
                <option value="10">UTC+10</option>
                <option value="11">UTC+11</option>
                <option value="12">UTC+12</option>
            </select>
        </div>

        <label>Campaign End Date & Time:</label>
        <div class="date-group">
            <select id="endYear">
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
                <option value="2029">2029</option>
                <option value="2030">2030</option>
            </select>
            <select id="endMonth">
                <option value="1">01 - January</option>
                <option value="2">02 - February</option>
                <option value="3">03 - March</option>
                <option value="4">04 - April</option>
                <option value="5">05 - May</option>
                <option value="6">06 - June</option>
                <option value="7">07 - July</option>
                <option value="8">08 - August</option>
                <option value="9">09 - September</option>
                <option value="10">10 - October</option>
                <option value="11">11 - November</option>
                <option value="12">12 - December</option>
            </select>
            <select id="endDay"></select>
            <select id="endHour"></select>
            <select id="endMin"></select>
            <select id="endSec"></select>
            <select id="endTimezone">
                <option value="-12">UTC-12</option>
                <option value="-11">UTC-11</option>
                <option value="-10">UTC-10</option>
                <option value="-9">UTC-9</option>
                <option value="-8">UTC-8</option>
                <option value="-7">UTC-7</option>
                <option value="-6">UTC-6</option>
                <option value="-5">UTC-5</option>
                <option value="-4">UTC-4</option>
                <option value="-3">UTC-3</option>
                <option value="-2">UTC-2</option>
                <option value="-1">UTC-1</option>
                <option value="0">UTC+0</option>
                <option value="1">UTC+1</option>
                <option value="2">UTC+2</option>
                <option value="3">UTC+3</option>
                <option value="4">UTC+4</option>
                <option value="5">UTC+5</option>
                <option value="6">UTC+6</option>
                <option value="7">UTC+7</option>
                <option value="8">UTC+8</option>
                <option value="9">UTC+9</option>
                <option value="10">UTC+10</option>
                <option value="11">UTC+11</option>
                <option value="12">UTC+12</option>
            </select>
        </div>

        <label for="cuepoints">Cuepoints (comma-separated, in seconds, e.g., 300,600,900):</label>
        <input type="text" id="cuepoints" required>

        <label for="title">Title (Max 50 characters):</label>
        <input type="text" id="title" required maxlength="50">

        <label for="content">Content Body (Optional, Max 120 characters):</label>
        <input type="text" id="content" maxlength="120">

        <label for="cta">CTA Button (Max 15 characters):</label>
        <input type="text" id="cta" required maxlength="15">

        <label for="landing">Landing Page[](https://...):</label>
        <input type="url" id="landing" required pattern="https://.*">

        <label>Episode Input Type:</label>
        <div>
            <label><input type="radio" name="episodeInput" value="direct" checked> Direct Input</label>
            <label><input type="radio" name="episodeInput" value="file"> File Upload</label>
        </div>

        <div id="directGroup">
            <label for="seriesId">Series ID (optional, blank default):</label>
            <input type="text" id="seriesId">

            <label for="productIds">Selected Product IDs (comma-separated, e.g., 2671541,2671769):</label>
            <input type="text" id="productIds">
        </div>

        <div id="fileGroup" style="display: none;">
            <label for="episodeFile">Upload Episode File (.xlsx):</label>
            <input type="file" id="episodeFile" accept=".xlsx">
            <a href="http://yongxun1991.github.io/htmlupload/sample.xlsx" download="sample_episode_ids.xlsx">Download Sample File</a>
        </div>

        <label>Country Selection (Multiple):</label>
        <div class="checkbox-group" id="countriesGroup">
            <label><input type="checkbox" name="countries" value="1819730|hk"> Hong Kong (HK)</label>
            <label><input type="checkbox" name="countries" value="1880251|sg"> Singapore (SG)</label>
            <label><input type="checkbox" name="countries" value="1605651|th"> Thailand (TH)</label>
            <label><input type="checkbox" name="countries" value="1694008|ph"> Philippines (PH)</label>
            <label><input type="checkbox" name="countries" value="1643084|id"> Indonesia (ID)</label>
            <label><input type="checkbox" name="countries" value="1733045|my"> Malaysia (MY)</label>
            <label><input type="checkbox" name="countries" value="286963|om"> Oman (OM) - GCC</label>
            <label><input type="checkbox" name="countries" value="285570|kw"> Kuwait (KW) - GCC</label>
            <label><input type="checkbox" name="countries" value="290291|bh"> Bahrain (BH) - GCC</label>
            <label><input type="checkbox" name="countries" value="102358|sa"> Saudi Arabia (SA) - GCC</label>
            <label><input type="checkbox" name="countries" value="289688|qa"> Qatar (QA) - GCC</label>
            <label><input type="checkbox" name="countries" value="69543|ye"> Yemen (YE) - GCC</label>
            <label><input type="checkbox" name="countries" value="290557|ae"> United Arab Emirates (AE) - GCC</label>
            <label><input type="checkbox" name="countries" value="357994|eg"> Egypt (EG) - North Africa</label>
            <label><input type="checkbox" name="countries" value="2542007|ma"> Morocco (MA) - North Africa</label>
            <label><input type="checkbox" name="countries" value="366755|sd"> Sudan (SD) - North Africa</label>
            <label><input type="checkbox" name="countries" value="2464461|tn"> Tunisia (TN) - North Africa</label>
            <label><input type="checkbox" name="countries" value="2589581|dz"> Algeria (DZ) - North Africa</label>
            <label><input type="checkbox" name="countries" value="99237|iq"> Iraq (IQ) - Levant</label>
            <label><input type="checkbox" name="countries" value="272103|lb"> Lebanon (LB) - Levant</label>
            <label><input type="checkbox" name="countries" value="6254930|ps"> Palestine (PS) - Levant</label>
            <label><input type="checkbox" name="countries" value="248816|jo"> Jordan (JO) - Levant</label>
            <label><input type="checkbox" name="countries" value="1327865|mm"> Myanmar (MM)</label>
            <label><input type="checkbox" name="countries" value="953987|za"> South Africa (ZA)</label>
        </div>

        <label>User Type (Multiple):</label>
        <div class="checkbox-group">
            <label><input type="checkbox" name="userTypes" value="anonymous"> Anonymous</label>
            <label><input type="checkbox" name="userTypes" value="free"> Free</label>
            <label><input type="checkbox" name="userTypes" value="premium"> Premium</label>
        </div>

        <label>Platform (Multiple):</label>
        <div class="checkbox-group">
            <label><input type="checkbox" name="platforms" value="web"> Web</label>
            <label><input type="checkbox" name="platforms" value="pad"> Pad</label>
            <label><input type="checkbox" name="platforms" value="phone"> Phone</label>
        </div>

        <label for="duration">On-Screen Duration (in seconds, max 30):</label>
        <input type="number" id="duration" min="1" max="30" required>

        <label for="batchLabel">Batch Label (Max 6 characters):</label>
        <input type="text" id="batchLabel" maxlength="6">

        <button type="button" onclick="generateCSV()">Convert to CSV</button>
        <button type="button" onclick="generateXLSX()">Convert to Complete Infoline XLSX Form</button>
    </form>

    <div id="preview"></div>

    <script>
        function pad2(num) { return num.toString().padStart(2, '0'); }

        function populateSelects() {
            let daysHtml = '';
            for (let i = 1; i <= 31; i++) {
                daysHtml += `<option value="${i}">${pad2(i)} - Day</option>`;
            }
            document.getElementById('startDay').innerHTML = daysHtml;
            document.getElementById('endDay').innerHTML = daysHtml;

            let hoursHtml = '';
            for (let i = 0; i <= 23; i++) {
                hoursHtml += `<option value="${i}">${pad2(i)} - Hour</option>`;
            }
            document.getElementById('startHour').innerHTML = hoursHtml;
            document.getElementById('endHour').innerHTML = hoursHtml;

            let minsHtml = '';
            for (let i = 0; i <= 59; i++) {
                minsHtml += `<option value="${i}">${pad2(i)} - Minute/Second</option>`;
            }
            document.getElementById('startMin').innerHTML = minsHtml;
            document.getElementById('endMin').innerHTML = minsHtml;
            document.getElementById('startSec').innerHTML = minsHtml;
            document.getElementById('endSec').innerHTML = minsHtml;
        }

        function getUnixTimestamp(year, month, day, hour, min, sec, offset) {
            let date = new Date(Date.UTC(year, month - 1, day, hour, min, sec));
            date.setUTCHours(date.getUTCHours() - parseInt(offset));
            return Math.floor(date.getTime() / 1000);
        }

        function formatDate(year, month, day) {
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function csvEscape(field) {
            let str = field.toString();
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                str = '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
        }

        function parseCSVLine(line) {
            let cells = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"' && !inQuote) {
                    inQuote = true;
                } else if (char === '"' && inQuote) {
                    if (line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuote = false;
                    }
                } else if (char === ',' && !inQuote) {
                    cells.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            if (current) cells.push(current);
            return cells;
        }

        document.querySelectorAll('input[name="episodeInput"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('directGroup').style.display = radio.value === 'direct' ? 'block' : 'none';
                document.getElementById('fileGroup').style.display = radio.value === 'file' ? 'block' : 'none';
            });
        });

        async function getData() {
            const advertiser = document.getElementById('advertiser').value;
            const campaignName = document.getElementById('campaignName').value.replace(/\s/g, '');
            const region = document.getElementById('region').value;
            const startYear = parseInt(document.getElementById('startYear').value);
            const startMonth = parseInt(document.getElementById('startMonth').value);
            const startDay = parseInt(document.getElementById('startDay').value);
            const startHour = parseInt(document.getElementById('startHour').value);
            const startMin = parseInt(document.getElementById('startMin').value);
            const startSec = parseInt(document.getElementById('startSec').value);
            const startTimezone = document.getElementById('startTimezone').value;
            const endYear = parseInt(document.getElementById('endYear').value);
            const endMonth = parseInt(document.getElementById('endMonth').value);
            const endDay = parseInt(document.getElementById('endDay').value);
            const endHour = parseInt(document.getElementById('endHour').value);
            const endMin = parseInt(document.getElementById('endMin').value);
            const endSec = parseInt(document.getElementById('endSec').value);
            const endTimezone = document.getElementById('endTimezone').value;
            const yymm = startYear.toString().slice(-2) + pad2(startMonth);
            const backendName = `Infoline_${region}_${campaignName}_${yymm}`;
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const cta = document.getElementById('cta').value;
            const landing = document.getElementById('landing').value;
            const duration = document.getElementById('duration').value;
            const cueStr = document.getElementById('cuepoints').value;
            const batchLabel = document.getElementById('batchLabel').value;

            if (!campaignName || !region || !cueStr || !title || !cta || !landing || !duration) {
                throw new Error('Missing required fields');
            }

            const cues = cueStr.split(',').map(c => c.trim()).filter(c => c);

            if (cues.length === 0) {
                throw new Error('No valid cuepoints provided');
            }

            let episodes = [];
            const inputType = document.querySelector('input[name="episodeInput"]:checked').value;
            if (inputType === 'direct') {
                const seriesId = document.getElementById('seriesId').value.trim();
                const productStr = document.getElementById('productIds').value;
                if (!productStr) {
                    throw new Error('No product IDs provided for direct input');
                }
                const products = productStr.split(',').map(p => p.trim()).filter(p => p);
                if (products.length === 0) {
                    throw new Error('No valid product IDs provided');
                }
                episodes = products.map(p => ({seriesId: seriesId || '', productId: p}));
            } else if (inputType === 'file') {
                const file = document.getElementById('episodeFile').files[0];
                if (!file) {
                    throw new Error('No episode file uploaded');
                }
                const rows = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = e.target.result;
                        const wb = XLSX.read(data, {type: 'binary'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(ws, {header: 1}));
                    };
                    reader.onerror = reject;
                    reader.readAsBinaryString(file);
                });

                let currentSeries = null;
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.length < 5) continue;
                    if (row[2]) currentSeries = row[2];
                    if (row[4] && currentSeries) episodes.push({seriesId: currentSeries, productId: row[4]});
                }

                if (episodes.length === 0) {
                    throw new Error('No episodes found in the uploaded file');
                }
            }

            const countryChecks = document.querySelectorAll('input[name="countries"]:checked');
            const selectedCountries = Array.from(countryChecks).map(check => {
                const [id, code] = check.value.split('|');
                return {id, code: code.toLowerCase()};
            });

            if (selectedCountries.length === 0) {
                throw new Error('At least one country must be selected');
            }

            const userChecks = document.querySelectorAll('input[name="userTypes"]:checked');
            const selectedUserTypes = Array.from(userChecks).map(check => check.value);
            const anon = selectedUserTypes.includes('anonymous') ? 1 : 0;
            const free = selectedUserTypes.includes('free') ? 1 : 0;
            const prem = selectedUserTypes.includes('premium') ? 1 : 0;

            let userTypeStr = '';
            if (prem) {
                userTypeStr = 'Paid';
            } else if (anon && free) {
                userTypeStr = 'Anonymous and Free (Default)';
            } else {
                userTypeStr = selectedUserTypes.join(' and ');
            }

            const platformChecks = document.querySelectorAll('input[name="platforms"]:checked');
            const selectedPlatforms = Array.from(platformChecks).map(check => check.value);

            if (selectedPlatforms.length === 0) {
                throw new Error('At least one platform must be selected');
            }

            const platformStr = selectedPlatforms.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('/ ');

            const startUnix = getUnixTimestamp(startYear, startMonth, startDay, startHour, startMin, startSec, startTimezone);
            const endUnix = getUnixTimestamp(endYear, endMonth, endDay, endHour, endMin, endSec, endTimezone);

            if (startUnix >= endUnix) {
                throw new Error('Start time must be before end time');
            }

            const startDateStr = formatDate(startYear, startMonth, startDay);
            const endDateStr = formatDate(endYear, endMonth, endDay);

            let combinations = [];
            episodes.forEach(episode => {
                cues.forEach(cue => {
                    selectedCountries.forEach(country => {
                        combinations.push({
                            seriesId: episode.seriesId,
                            product: episode.productId,
                            cue,
                            country_id: country.id,
                            country_code: country.code
                        });
                    });
                });
            });

            let groups = {};
            combinations.forEach(combo => {
                if (!groups[combo.product]) groups[combo.product] = [];
                groups[combo.product].push(combo);
            });

            Object.keys(groups).forEach(product => {
                const group = groups[product];
                group.forEach((combo, index) => {
                    combo.running_number = pad2(index + 1);
                });
            });

            const seriesIds = [...new Set(episodes.map(e => e.seriesId).filter(s => s))].join(', ');

            return {
                advertiser,
                campaignName,
                region,
                yymm,
                backendName,
                title,
                content,
                cta,
                landing,
                duration,
                cueStr,
                batchLabel,
                combinations,
                anon,
                free,
                prem,
                startUnix,
                endUnix,
                selectedPlatforms,
                startDateStr,
                endDateStr,
                userTypeStr,
                platformStr,
                seriesIds
            };
        }

        async function generateCSV() {
            try {
                const data = await getData();
                const headers = ['series_id','product_id','batch_id','name','backend_name','cover_image_uri','start_time','time_duration','popup_content','ad_tag','ad_link','ad_auto_show_anonymous_user','ad_auto_show_free_user','ad_auto_show_premium_user','ad_schedule_start_time','ad_schedule_end_time','platform','country_ids'];
                let csvRows = [headers.join(',')];

                data.combinations.forEach(combo => {
                    const batchId = `${combo.country_code}${data.yymm}${combo.running_number}${data.batchLabel}`;
                    const row = [
                        combo.seriesId,
                        combo.product,
                        batchId,
                        data.title,
                        data.backendName,
                        '',
                        combo.cue,
                        data.duration,
                        data.content,
                        data.cta,
                        data.landing,
                        data.anon,
                        data.free,
                        data.prem,
                        data.startUnix,
                        data.endUnix,
                        JSON.stringify(data.selectedPlatforms),
                        combo.country_id
                    ].map(csvEscape);
                    csvRows.push(row.join(','));
                });

                const csvContent = csvRows.join('\n');

                // Download
                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.backendName}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Preview
                const previewDiv = document.getElementById('preview');
                previewDiv.innerHTML = '';
                const table = document.createElement('table');
                table.style.borderCollapse = 'collapse';
                table.style.width = '100%';

                function renderRows(limit) {
                    table.innerHTML = '';
                    csvRows.slice(0, limit).forEach(row => {
                        const cells = parseCSVLine(row);
                        const tr = table.insertRow();
                        cells.forEach(cell => {
                            const td = tr.insertCell();
                            td.textContent = cell;
                            td.style.border = '1px solid #ccc';
                            td.style.padding = '5px';
                        });
                    });
                }

                renderRows(21); // header + 20

                previewDiv.appendChild(table);

                if (csvRows.length > 21) {
                    const expandBtn = document.createElement('button');
                    expandBtn.textContent = 'Expand to 100 rows';
                    expandBtn.style.marginTop = '10px';
                    expandBtn.onclick = () => {
                        renderRows(Math.min(101, csvRows.length)); // header + 100 max
                        expandBtn.style.display = 'none';
                    };
                    previewDiv.appendChild(expandBtn);
                }
            } catch (e) {
                alert('Errors:\n- ' + e.message);
            }
        }

        async function generateXLSX() {
            try {
                const data = await getData();

                // Deprecated Spec Form
                const dep_spec_aoa = [
                    ["Preparation", "Input Text & Informaton", "Text Calculation for reference", "Remarks"],
                    ["Advertiser / Brand name", null, null, null],
                    ["Advertiser brand category", null, null, null],
                    ["Campaign Budget", null, null, null],
                    ["Targeted impressions", null, null, null],
                    ["Backend Name (Optional)", null, null, null],
                    ["Ad Start Date & Time", null, null, "Defualt: Running at 00:00 on start date"],
                    ["Ad End Date & Time", null, null, "Defualt: Stop running at 23:59 on end date"],
                    ["Cover Image (封面)", null, null, "16:9 — Min. resolution 682x384px\nMax. file size 60kb"],
                    ["Ad Name (广告名称)", null, 0, "Max 50 characters with space / 25 Chinese or Thai characters with space"],
                    ["Infoline Ad Duration (广告持续时长(秒))", null, null, "In sec (Default the length in 6 sec)"],
                    ["Infoline Content (Optional)\n(广告内容)", null, 0, "Max 100 characters with space / 50 Chinese or Thai characters with space"],
                    ["Infoline Button Label (广告按钮标签)", null, 0, "Max. 12 English characters with space / 6 Chinese or Thai characters with space"],
                    ["Infoline Landing URL (广告链接)", null, null, "http:// or https://"],
                    [null, null, null, null],
                    ["Targeting", null, null, null],
                    ["Targeting Sence", null, null, "E.g. Crying/ Kissing/ Nude & Bath"],
                    ["Languages", null, null, "Depending on content availability (Default for all avaliable language on local market)"],
                    ["User type", null, null, "E.g. Anonymous and Free (Default) / Paid \n** Non-targeted users can still click to see the infoline ad"],
                    ["Platform", null, null, "E.g. Web/ Mobile App/ Tablet App"],
                    ["Additional Information (If Any)", null, null, "E.g. Category/ Series/ Episode"],
                    [null, null, null, null],
                    ["Internal Use", null, null, null],
                    ["* Backend Name 广告后台名称", "Backend Name Generator", null, null]
                ];

                // Spec Form
                const spec_aoa = [
                    [`Suggested file name: Infoline_{region id}_{campaign name}_{campaign start month/year: yymm}`, null, null, null],
                    [null, null, null, null],
                    ["Preparation", "Input Text & Informaton", "Text Calculation for reference", "Remarks", "updated 19 Mar., 2024"],
                    ["Advertiser / Brand name", data.advertiser, null, null],
                    ["Advertiser brand category", null, null, null],
                    ["Campaign Budget", null, null, null],
                    ["Targeted impressions", null, null, null],
                    ["Ad Start Date & Time", data.startDateStr, null, "Defualt: Running at 00:00 on start date"],
                    ["Ad End Date & Time", data.endDateStr, null, "Defualt: Stop running at 23:59 on end date"],
                    ["Ad Name/Campaign Name ", data.campaignName, data.campaignName.length, "Max 50 characters with space / 25 Chinese or Thai characters with space"],
                    ["Backend Name ", data.backendName, null, "Backend Name Generator"],
                    ["Cover Image", "as attached", null, "16:9 — Min. resolution 682x384px\nMax. file size 60kb\n"],
                    ["Ads start time (in second)", data.cueStr, null, null],
                    ["Infoline Ad Duration ", data.duration, null, "In sec (Default the length in 6 sec)"],
                    ["Infoline Content (Optional)\n(广告内容)", data.content, data.content.length, "Max 100 characters with space / 50 Chinese or Thai characters with space"],
                    ["Infoline Button Label ", data.cta, data.cta.length, "Max.12 English characters with space / 6 Chinese or Thai characters with space"],
                    ["Infoline Landing URL", data.landing, null, "http:// or https://"],
                    [null, null, null, null],
                    ["Targeting", null, null, null],
                    ["Targeting Scene", null, null, "E.g. Crying/ Kissing/ Nude & Bath"],
                    ["Languages", null, null, "Depending on content availability (Default for all avaliable language on local market)"],
                    ["User type/Auto Display", data.userTypeStr, null, "E.g. Anonymous and Free (Default) / Paid \n** Non-targeted users can still click to see the infoline ad"],
                    ["Platform", data.platformStr, null, "E.g. Web/ Mobile App/ Tablet App"],
                    ["Series ID", data.seriesIds, null, null],
                    ["Additional Information (If Any)", null, null, "E.g. Category/ Series/ Episode"]
                ];

                // Dep Bulk
                const dep_bulk_aoa = [
                    ["(A) Campaign already inserted", null, null, null, null, null, "(B) Bulk upload", null, null, null],
                    ["Infoline Ad ID", "Series ID", "Product ID", "Timestamp", "Campaign start date", "Campaign end date", "Series ID", "Product ID", "Timestamp", "Ad duration"],
                    [null, 117344, 3853492, 180, 45275, 45291, 117344, 3853492, 180, 30],
                    [null, null, null, null, null, null, 117344, 3853492, 380, 30],
                    [null, null, null, null, null, null, 117344, 3853438, 757, 30],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    [null, null, null, null, null, null, null, null, null, null],
                    ["Steps:\n1. AdOps team fill up the campaign start/end date in section (A) and column G to J in the section (B)\n2. AdOps team submit GSF with the Google link\n3. Support team pick the 1st row from section (B) and configure in the CMS (remarks: Product ID=Episode ID in CMS)\n4. Support team fill the \"Infoline Ad ID\" in section (A) with the information configured in the CMS\n5. Support team export the file in CSV format and upload to corresponding Jira \n6. Once the file is confirmed by AdOps team, the Support team tag Daniel in the Jira for bulk upload action", null, null, null, null, null, null, null, null, null]
                ];

                // New Bulk
                const bulk_aoa = [
                    [null, null, "Batch ID", "Title", "Backend Name", "Cover", "Ads start time (in second)", "Infoline Ad Duration", "Infoline Content", "Infoline Button Label", "Infoline Landing", "Auto Display", "Auto Display", "Auto Display", "Ads Start Date", "Ads End Date", "platform", null],
                    ["Series ID", "product_id", "batch_id", "name", "backend_name", "cover_image_uri", "start_time", "time_duration", "popup_content", "ad_tag", "ad_link", "ad_auto_show_anonymous_user", "ad_auto_show_free_user", "ad_auto_show_premium_user", "ad_schedule_start_time", "ad_schedule_end_time", "platform", "country_ids"]
                ];

                data.combinations.forEach(combo => {
                    const batchId = `${combo.country_code}${data.yymm}${combo.running_number}${data.batchLabel}`;
                    bulk_aoa.push([
                        combo.seriesId,
                        combo.product,
                        batchId,
                        data.title,
                        data.backendName,
                        '',
                        combo.cue,
                        data.duration,
                        data.content,
                        data.cta,
                        data.landing,
                        data.anon,
                        data.free,
                        data.prem,
                        data.startUnix,
                        data.endUnix,
                        JSON.stringify(data.selectedPlatforms),
                        combo.country_id
                    ]);
                });

                // Country ID
                const country_aoa = [
                    ["Country Code", "Country Name", "Country ID", "Default Language / Code"],
                    ["Hong Kong", "HK", "Hong Kong", 1819730],
                    ["Singapore", "SG", "Singapore", 1880251],
                    ["Thailand", "TH", "Thailand", 1605651],
                    ["Philippines", "PH", "Philippines", 1694008],
                    ["Indonesia", "ID", "Indonesia", 1643084],
                    ["Malaysia", "MY", "Malaysia", 1733045],
                    ["Gulf Co-operation Council (GCC)", "OM", "Oman", 286963],
                    [null, "KW", "Kuwait", 285570],
                    [null, "BH", "Bahrain", 290291],
                    [null, "SA", "Saudi Arabia", 102358],
                    [null, "QA", "Qatar", 289688],
                    [null, "YE", "Yemen", 69543],
                    [null, "AE", "United Arabs Emirates", 290557],
                    ["North Africa", "EG", "Egypt", 357994],
                    [null, "MA", "Morocco", 2542007],
                    [null, "SD", "Sudan", 366755],
                    [null, "TN", "Tunisia", 2464461],
                    [null, "DZ", "Algeria", 2589581],
                    ["Levant", "IQ", "Iraq", 99237],
                    [null, "LB", "Lebanon", 272103],
                    [null, "PS", "Palestine", 6254930],
                    [null, "JO", "Jordan", 248816],
                    ["Myanmar", "MM", "Myanmar", 1327865],
                    ["South Africa", "ZA", "South Africa", 953987]
                ];

                const wb = XLSX.utils.book_new();

                // Add sheets with improved styling
                const addSheet = (aoa, name) => {
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    ws['!cols'] = [{wch: 30}, {wch: 30}, {wch: 25}, {wch: 50}, {wch: 20}]; // Approximate column widths
                    ws['!rows'] = new Array(aoa.length).fill({hpt: 15}); // Row heights

                    // Style header row
                    for (let R = 0; R < aoa.length; ++R) {
                        for (let C = 0; C < aoa[R].length; ++C) {
                            const cell = XLSX.utils.encode_cell({r: R, c: C});
                            if (!ws[cell]) continue;
                            if (!ws[cell].s) ws[cell].s = {};
                            if (R === 2) { // Preparation row
                                ws[cell].s.fill = {patternType: "solid", fgColor: {rgb: "F4B084"}}; // Orange-yellow
                                ws[cell].s.font = {bold: true};
                                ws[cell].s.alignment = {vertical: "center", wrapText: true};
                            } else if (R === 0 || R === 1) {
                                ws[cell].s.font = {italic: true};
                            } else {
                                if (C === 0) {
                                    ws[cell].s.font = {bold: true};
                                }
                            }
                        }
                    }

                    XLSX.utils.book_append_sheet(wb, ws, name);
                };

                const addBulkSheet = (aoa, name) => {
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    ws['!cols'] = [{wch: 15}, {wch: 15}, {wch: 15}, {wch: 25}, {wch: 30}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 20}, {wch: 25}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];
                    ws['!rows'] = new Array(aoa.length).fill({hpt: 15});

                    // Style headers
                    for (let C = 0; C < aoa[1].length; ++C) {
                        const cell = XLSX.utils.encode_cell({r:1, c:C});
                        if (!ws[cell]) continue;
                        ws[cell].s = {font: {bold: true}, fill: {patternType: "solid", fgColor: {rgb: "FFFF00"}}}; // Yellow
                    }

                    XLSX.utils.book_append_sheet(wb, ws, name);
                };

                const addCountrySheet = (aoa, name) => {
                    const ws = XLSX.utils.aoa_to_sheet(aoa);
                    ws['!cols'] = [{wch: 30}, {wch: 5}, {wch: 20}, {wch: 20}];
                    ws['!rows'] = new Array(aoa.length).fill({hpt: 15});

                    // Style header
                    for (let C = 0; C < aoa[0].length; ++C) {
                        const cell = XLSX.utils.encode_cell({r:0, c:C});
                        ws[cell].s = {font: {bold: true}, fill: {patternType: "solid", fgColor: {rgb: "ADD8E6"}}}; // Light blue
                    }

                    // Merge cells for regions
                    ws['!merges'] = [
                        {s: {r:7, c:0}, e: {r:13, c:0}}, // GCC
                        {s: {r:14, c:0}, e: {r:18, c:0}}, // North Africa
                        {s: {r:19, c:0}, e: {r:22, c:0}}, // Levant
                    ];

                    XLSX.utils.book_append_sheet(wb, ws, name);
                };

                addSheet(dep_spec_aoa, "(deprecated) Infoline Spec Form");
                addSheet(spec_aoa, "Infoline Spec Form");
                addBulkSheet(dep_bulk_aoa, "(dep)Infoline Bulk upload templ");
                addBulkSheet(bulk_aoa, "NEW! Infoline Bulk upload templ");
                addCountrySheet(country_aoa, "country id");

                XLSX.writeFile(wb, `${data.backendName}.xlsx`);
            } catch (e) {
                alert('Errors:\n- ' + e.message);
            }
        }

        populateSelects();
    </script>
</body>
</html>
